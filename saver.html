<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Carga de Tarimas con C치mara</title>
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>游닍</text></svg>">
    <!-- Stylesheets -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4361ee;
            --primary-hover: #3a56d4;
            --dark: #1b263b;
            --light: #f8f9fa;
            --card-bg: #ffffff;
            --text: #2b2d42;
            --danger: #f72585;
            --border-radius: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--light);
            color: var(--text);
            touch-action: manipulation;
        }

        .container {
            display: none; /* Oculto inicialmente */
            padding: 1rem;
            max-width: 100%;
        }

        /* Estilos de c치mara (igual que antes) */
        .camera-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        /* ... (Mant칠n todos los estilos de c치mara del ejemplo anterior) ... */

        /* Nuevos estilos para el flujo integrado */
        .photo-counter {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 20px;
            font-size: 0.8rem;
            z-index: 10;
        }

        .btn-next {
            position: absolute;
            bottom: 5rem;
            right: 1rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
    </style>
</head>
<body>
    <!-- Contenedor de C치mara (visible primero) -->
    <div class="camera-container" id="cameraContainer">
        <button class="btn-close" id="btnClose">
            <i class="fas fa-times"></i>
        </button>
        <button class="btn-flip" id="btnFlip">
            <i class="fas fa-camera-retro"></i>
        </button>
        <video id="cameraView" autoplay playsinline></video>
        <div class="flash" id="flashEffect"></div>
        <div class="photo-counter" id="photoCounter">0/5 fotos</div>
        
        <div class="controls">
            <button class="btn-camera btn-capture" id="btnCapture">
                <i class="fas fa-camera"></i>
            </button>
        </div>
        
        <button class="btn-next" id="btnNext" style="display: none;">
            <i class="fas fa-check"></i>
        </button>
    </div>

    <!-- Contenedor del Formulario (oculto inicialmente) -->
    <div class="container" id="formContainer">
        <header>
            <div class="header-title">
                <i class="fas fa-pallet"></i>
                <h1>Carga de Tarimas</h1>
            </div>
        </header>

        <form id="tarimaForm">
            <div class="form-section">
                <div class="form-group">
                    <label for="tienda">Tienda</label>
                    <select id="tienda" name="tienda" required>
                        <option value="">Seleccionar</option>
                        <option value="hogar1">Hogar 1</option>
                        <option value="hogar2">Hogar 2</option>
                        <option value="eplastik">Eplastik</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="numeroTarima">N칰mero</label>
                    <input type="number" id="numeroTarima" name="numeroTarima" required placeholder="Ej: 101">
                </div>
                
                <div class="form-group">
                    <label>Fecha de env칤o</label>
                    <div class="form-value" id="fechaEnvioDisplay"></div>
                </div>
            </div>
            
            <div class="form-section">
                <div class="form-group">
                    <label for="observaciones">Observaciones</label>
                    <input type="text" id="observaciones" name="observaciones" placeholder="Opcional">
                </div>
            </div>
            
            <div class="form-section">
                <div class="preview-container" id="previewContainer"></div>
            </div>
            
            <button type="submit" class="btn" style="width: 100%;">
                <i class="fas fa-check icon"></i>
                <span>Enviar tarima</span>
            </button>
        </form>
    </div>

    <script>
        // Variables globales
        let capturedPhotos = [];
        const MAX_PHOTOS = 5;

        // Iniciar c치mara al cargar
        document.addEventListener('DOMContentLoaded', function() {
            startCameraFlow();
        });

        // ===== FUNCIONES DE C츼MARA =====
        async function startCameraFlow() {
            document.getElementById('cameraContainer').style.display = 'flex';
            document.getElementById('formContainer').style.display = 'none';
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: "environment" },
                    audio: false
                });
                document.getElementById('cameraView').srcObject = stream;
                
                // Event Listeners
                document.getElementById('btnCapture').addEventListener('click', capturePhoto);
                document.getElementById('btnFlip').addEventListener('click', flipCamera);
                document.getElementById('btnNext').addEventListener('click', showForm);
                document.getElementById('btnClose').addEventListener('click', () => {
                    window.location.href = "index.html"; // Ajusta seg칰n tu flujo
                });
                
            } catch (error) {
                console.error("Error al acceder a la c치mara:", error);
                alert("No se pudo acceder a la c치mara. Se usar치 el m칠todo tradicional.");
                showForm(); // Fallback a formulario sin fotos
            }
        }

        function capturePhoto() {
            const cameraView = document.getElementById('cameraView');
            const flashEffect = document.getElementById('flashEffect');
            
            // Efecto flash
            flashEffect.classList.add('flash-active');
            setTimeout(() => flashEffect.classList.remove('flash-active'), 300);
            
            // Crear canvas para captura
            const canvas = document.createElement('canvas');
            canvas.width = cameraView.videoWidth;
            canvas.height = cameraView.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(cameraView, 0, 0, canvas.width, canvas.height);
            
            // Guardar foto
            capturedPhotos.push(canvas.toDataURL('image/jpeg'));
            updatePhotoCounter();
            
            // Mostrar bot칩n "Siguiente" si hay fotos
            if (capturedPhotos.length > 0) {
                document.getElementById('btnNext').style.display = 'flex';
            }
            
            // Si alcanz칩 el m치ximo, pasar al formulario
            if (capturedPhotos.length >= MAX_PHOTOS) {
                showForm();
            }
        }

        function updatePhotoCounter() {
            document.getElementById('photoCounter').textContent = 
                `${capturedPhotos.length}/${MAX_PHOTOS} fotos`;
        }

        function flipCamera() {
            // Implementa el cambio de c치mara frontal/trasera
            console.log("Cambiar c치mara");
        }

        // ===== FUNCIONES DE FORMULARIO =====
        function showForm() {
            // Detener c치mara
            const stream = document.getElementById('cameraView').srcObject;
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            
            // Ocultar c치mara, mostrar formulario
            document.getElementById('cameraContainer').style.display = 'none';
            document.getElementById('formContainer').style.display = 'block';
            
            // Mostrar fotos capturadas
            displayCapturedPhotos();
            
            // Configurar fecha actual
            const now = new Date();
            document.getElementById('fechaEnvioDisplay').textContent = 
                now.toLocaleDateString('es-ES') + ' ' + now.toLocaleTimeString().slice(0, 5);
            
            // Configurar env칤o del formulario
            document.getElementById('tarimaForm').addEventListener('submit', function(e) {
                e.preventDefault();
                submitFormData();
            });
        }

        function displayCapturedPhotos() {
            const previewContainer = document.getElementById('previewContainer');
            previewContainer.innerHTML = '';
            
            capturedPhotos.forEach((photoData, index) => {
                const previewItem = document.createElement('div');
                previewItem.className = 'preview-item';
                previewItem.innerHTML = `
                    <img src="${photoData}">
                    <button class="remove-btn" onclick="removePhoto(${index})">칑</button>
                `;
                previewContainer.appendChild(previewItem);
            });
        }

        function removePhoto(index) {
            capturedPhotos.splice(index, 1);
            displayCapturedPhotos();
        }

        function submitFormData() {
            // Aqu칤 implementar칤as el env칤o al servidor
            const formData = {
                tienda: document.getElementById('tienda').value,
                numeroTarima: document.getElementById('numeroTarima').value,
                observaciones: document.getElementById('observaciones').value,
                fotos: capturedPhotos // Array de Data URLs
            };
            
            console.log("Datos a enviar:", {
                ...formData,
                fotos: `${formData.fotos.length} im치genes`
            });
            
            // Simular env칤o
            alert(`Tarima ${formData.numeroTarima} enviada con ${formData.fotos.length} fotos`);
            
            // Resetear flujo
            capturedPhotos = [];
            startCameraFlow();
        }

        // Hacer accesible desde HTML
        window.removePhoto = removePhoto;
    </script>
</body>
</html>
